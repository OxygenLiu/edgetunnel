name: Sync with Upstream EdgeTunnel

on:
  # Run daily at 2 AM UTC to check for updates
  schedule:
   - cron: '0 2 * * *'
    # Allow manual trigger
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/cmliu/edgetunnel.git || true
          git fetch upstream

      - name: Sync with upstream
        run: |
          # Check if there are any differences between main and upstream/main
          if git diff --quiet HEAD upstream/main; then
            echo "âœ… No changes from upstream - repository is up to date"
          else
            echo "ðŸ”„ Changes detected from upstream - syncing..."
            # Merge upstream changes
            git merge upstream/main --no-edit
            # Push the changes
            git push origin main
            echo "âœ… Successfully synced with upstream and pushed changes"
            echo "ðŸš€ Cloudflare Workers will auto-update from the repository"
          fi
